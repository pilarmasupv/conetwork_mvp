<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expert Knowledge Graph</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin:0; font-family:'Inter',sans-serif; background:#f9f9fb; }
    header { background:#2c0247; color:white; padding:0.8rem 2rem; font-size:1.4rem; font-weight:600; display:flex; align-items:center; justify-content:space-between; }
    .tabs { display:flex; gap:1rem; }
    .tab { cursor:pointer; padding:0.4rem 0.8rem; border-radius:6px; }
    .tab.active { background:#8e2de2; }
    main { height:calc(100vh - 60px); display:flex; justify-content:center; align-items:center; background:#f3f0f7; }
    svg { width:100%; height:100%; }
    .node { stroke:white; stroke-width:1.2px; cursor:pointer; }
    .link { stroke:#bbb; stroke-opacity:0.6; cursor:pointer; }
    /* Floating filters bar */
    .filters { position:fixed; bottom:0; left:0; right:0; background:white; border-top:1px solid #ddd; padding:0.6rem 1rem; display:flex; gap:1rem; justify-content:center; align-items:center; box-shadow:0 -2px 8px rgba(0,0,0,0.1); }
    select,input,button { padding:0.4rem; border-radius:6px; border:1px solid #ccc; }
    select[multiple] { height:5rem; }
    button { background:#8e2de2; color:white; font-weight:600; cursor:pointer; border:none; }
    button:hover { background:#6a11cb; }
    /* Modal */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:white; margin:5% auto; padding:20px; border-radius:10px; width:600px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 15px rgba(0,0,0,0.4); }
    .close { float:right; font-size:20px; font-weight:bold; cursor:pointer; }
    .close:hover { color:#8e2de2; }
    .author-link { color:#6a11cb; cursor:pointer; }
    .author-link:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <header>
    <div>Expert Knowledge Graph</div>
    <div class="tabs" id="tabs"></div>
  </header>
  <main>
    <svg><g></g></svg>
  </main>

  <!-- Floating filters -->
  <div class="filters">
    <label>Countries</label>
    <select id="country" multiple><option value="all">All</option></select>

    <label>Subfields</label>
    <select id="subfield" multiple><option value="all">All</option></select>

    <label>Min Year</label>
    <input type="number" id="year" value="2000">

    <label>Author</label>
    <input type="text" id="author" placeholder="Search author...">

    <label>Color by</label>
    <select id="colorField">
      <option value="main_field">Main Field</option>
      <option value="gender">Gender</option>
      <option value="country">Country</option>
      <option value="subfield">Subfield</option>
      <option value="position">Position</option>
    </select>

    <button id="searchBtn">Apply</button>
  </div>

  <!-- Modal -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>

  <script>
    const svg = d3.select("svg").select("g");
    let simulation, link, node, currentField="all";
    const modal = document.getElementById("infoModal");
    const modalBody = document.getElementById("modal-body");
    document.querySelector(".close").onclick = () => modal.style.display = "none";

    const zoom = d3.zoom().scaleExtent([0.1, 3]).on("zoom", (event) => {
      svg.attr("transform", event.transform);
    });
    d3.select("svg").call(zoom);

    // Color function by selected field
    function nodeColor(d) {
      const field = document.getElementById("colorField").value;
      const palette = d3.schemeCategory10;
      const value = d[field] || "Other";
      return d3.scaleOrdinal(palette)(value);
    }

    function drawGraph(apiUrl) {
      fetch(apiUrl).then(r => r.json()).then(data => {
        link = svg.selectAll(".link")
          .data(data.edges, d => d.source.id + "-" + d.target.id)
          .join(
            enter => enter.append("line").attr("class","link").on("click",(e,d)=>showEdgeInfo(d)),
            update => update,
            exit => exit.remove()
          );

        node = svg.selectAll(".node")
          .data(data.nodes, d => d.id)
          .join(
            enter => enter.append("circle")
              .attr("class","node").attr("r",6).attr("fill", nodeColor)
              .on("click",(e,d)=>showNodeInfo(d))
              .append("title").text(d => `${d.id}\n${d.subfield}`),
            update => update.attr("fill", nodeColor),
            exit => exit.remove()
          );

        simulation = d3.forceSimulation(data.nodes)
          .force("link", d3.forceLink(data.edges).id(d => d.id).distance(80))
          .force("charge", d3.forceManyBody().strength(-60))
          .force("center", d3.forceCenter(window.innerWidth/2.5, window.innerHeight/2));

        simulation.on("tick", () => {
          svg.selectAll(".link")
            .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
          svg.selectAll(".node")
            .attr("cx", d => d.x).attr("cy", d => d.y);
        });
      });
    }

    function showNodeInfo(d){
      modalBody.innerHTML = `
        <h3>${d.id}</h3>
        <p><b>Gender:</b> ${d.gender}</p>
        <p><b>Age:</b> ${d.age}</p>
        <p><b>Country:</b> ${d.country}</p>
        <p><b>Affiliation:</b> ${d.affiliation}</p>
        <p><b>Main Field:</b> ${d.main_field}</p>
        <p><b>Subfield:</b> ${d.subfield}</p>
        <p><b>Position:</b> ${d.position}</p>
        <p><b>Years Active:</b> ${d.years_active}</p>
        <p><b>Citations:</b> ${d.citations}</p>
        <p><b>H-Index:</b> ${d.h_index}</p>
        <p><b>ORCID:</b> ${d.orcid}</p>
        <p><b>Papers:</b><br>${d.papers ? d.papers.join("<br>") : "N/A"}</p>
      `;
      modal.style.display="block";
    }

    function showEdgeInfo(d){
      modalBody.innerHTML = `
        <h3>${d.paper_title}</h3>
        <p><b>Year:</b> ${d.year}</p>
        <p><b>Venue:</b> ${d.venue}</p>
        <p><b>Citations:</b> ${d.citations}</p>
        <p><b>Keywords:</b> ${d.keywords.join(", ")}</p>
        <p><b>Authors:</b><br>
          <span class="author-link">${d.source.id}</span><br>
          <span class="author-link">${d.target.id}</span>
        </p>
      `;
      modal.style.display="block";
      document.querySelectorAll(".author-link").forEach(el=>{
        el.onclick=()=>{
          const authorNode = simulation.nodes().find(n=>n.id===el.textContent);
          if (authorNode) showNodeInfo(authorNode);
        }
      });
    }

    // Populate filters
    fetch("/api/filters").then(r=>r.json()).then(filters=>{
      const countrySel=document.getElementById("country");
      const subfieldSel=document.getElementById("subfield");
      filters.countries.forEach(c=>countrySel.innerHTML+=`<option value="${c}">${c}</option>`);
      filters.subfields.forEach(s=>subfieldSel.innerHTML+=`<option value="${s}">${s}</option>`);
    });

    // Tabs for main fields
    fetch("/api/main_fields").then(r=>r.json()).then(fields=>{
      const tabs=document.getElementById("tabs");
      tabs.innerHTML=`<div class="tab active" data-field="all">All</div>`;
      fields.forEach(f=>{
        const el=document.createElement("div");
        el.className="tab";
        el.dataset.field=f;
        el.innerText=f;
        tabs.appendChild(el);
      });
      tabs.querySelectorAll(".tab").forEach(tab=>{
        tab.onclick=()=>{
          tabs.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
          tab.classList.add("active");
          currentField=tab.dataset.field;
          applyFilters();
        };
      });
    });

    // Initial load
    drawGraph("/api/graph");

    // Search button
    document.getElementById("searchBtn").addEventListener("click", applyFilters);

    function applyFilters(){
      const author=document.getElementById("author").value;
      const countries=Array.from(document.getElementById("country").selectedOptions).map(o=>o.value);
      const subfields=Array.from(document.getElementById("subfield").selectedOptions).map(o=>o.value);
      const year=document.getElementById("year").value;
      let url=`/api/graph?author=${author}&year=${year}&main_field=${currentField}`;
      countries.forEach(c=> url+=`&country=${c}`);
      subfields.forEach(s=> url+=`&subfield=${s}`);
      drawGraph(url);
    }

    // Recolor when color field changes
    document.getElementById("colorField").addEventListener("change",()=>{
      svg.selectAll(".node").attr("fill", nodeColor);
    });
  </script>
</body>
</html>

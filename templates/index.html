<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expert Connection Graph</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin:0; font-family:'Inter',sans-serif; background:#f7f5fb; }
    header { background:linear-gradient(90deg,#6a11cb 0%,#8e2de2 100%); color:white; padding:1rem 2rem; font-size:1.4rem; font-weight:600; }
    main { display:flex; height:calc(100vh - 70px); }
    aside { width:260px; background:white; padding:1rem; border-right:1px solid #ddd; }
    aside h3 { margin-top:0; color:#6a11cb; }
    select,input,button { width:100%; margin:0.5rem 0; padding:0.5rem; border-radius:6px; border:1px solid #ccc; }
    button { background:#8e2de2; color:white; font-weight:600; cursor:pointer; border:none; }
    button:hover { background:#6a11cb; }
    .graph-container { flex:1; display:flex; justify-content:center; align-items:center; background:#fafafa; }
    svg { width:100%; height:100%; }
    .node { fill:#8e2de2; stroke:white; stroke-width:1.2px; cursor:pointer; }
    .link { stroke:#bbb; stroke-opacity:0.6; cursor:pointer; }
    /* Modal */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); }
    .modal-content { background:white; margin:10% auto; padding:20px; border-radius:8px; width:420px; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
    .close { float:right; font-size:20px; font-weight:bold; cursor:pointer; }
    .close:hover { color:#8e2de2; }
  </style>
</head>
<body>
  <header>Expert Connection Graph</header>
  <main>
    <aside>
      <h3>Filters</h3>
      <label>Country</label>
      <select id="country"><option value="all">All</option></select>

      <label>Subfield</label>
      <select id="subfield"><option value="all">All</option></select>

      <label>Year (min)</label>
      <input type="number" id="year" value="2010">

      <label>Author</label>
      <input type="text" id="author" placeholder="Search author...">
      <button id="searchBtn">Search</button>
    </aside>
    <div class="graph-container">
      <svg></svg>
    </div>
  </main>

  <!-- Modal -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>

  <script>
    const svg = d3.select("svg");
    let simulation, link, node;
    const modal = document.getElementById("infoModal");
    const modalBody = document.getElementById("modal-body");
    document.querySelector(".close").onclick = () => modal.style.display = "none";

    function drawGraph(apiUrl) {
      fetch(apiUrl).then(r => r.json()).then(data => {
        svg.selectAll("*").remove();

        simulation = d3.forceSimulation(data.nodes)
          .force("link", d3.forceLink(data.edges).id(d => d.id).distance(80))
          .force("charge", d3.forceManyBody().strength(-70))
          .force("center", d3.forceCenter(window.innerWidth/2, window.innerHeight/2));

        link = svg.append("g")
          .selectAll("line")
          .data(data.edges).enter().append("line")
          .attr("class","link")
          .on("click",(e,d)=>showEdgeInfo(d));

        node = svg.append("g")
          .selectAll("circle")
          .data(data.nodes).enter().append("circle")
          .attr("class","node")
          .attr("r",6)
          .on("click",(e,d)=>showNodeInfo(d))
          .call(d3.drag()
            .on("start",dragstarted)
            .on("drag",dragged)
            .on("end",dragended));

        simulation.on("tick",()=>{
          link.attr("x1",d=>d.source.x).attr("y1",d=>d.source.y)
              .attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
          node.attr("cx",d=>d.x).attr("cy",d=>d.y);
        });
      });
    }

    function showNodeInfo(d){
      modalBody.innerHTML = `
        <h3>${d.id}</h3>
        <p><b>Gender:</b> ${d.gender}</p>
        <p><b>Country:</b> ${d.country}</p>
        <p><b>Affiliation:</b> ${d.affiliation}</p>
        <p><b>Subfield:</b> ${d.subfield}</p>
        <p><b>Citations:</b> ${d.citations}</p>
        <p><b>Papers:</b><br> ${d.papers ? d.papers.join("<br>") : "N/A"}</p>
      `;
      modal.style.display="block";
    }

    function showEdgeInfo(d){
      modalBody.innerHTML = `
        <h3>Co-authorship</h3>
        <p><b>Source:</b> ${d.source.id}</p>
        <p><b>Target:</b> ${d.target.id}</p>
        <p><b>Paper:</b> ${d.paper_title}</p>
        <p><b>Year:</b> ${d.year}</p>
        <p><b>Venue:</b> ${d.venue}</p>
      `;
      modal.style.display="block";
    }

    function dragstarted(e,d){ if(!e.active) simulation.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }
    function dragged(e,d){ d.fx=e.x; d.fy=e.y; }
    function dragended(e,d){ if(!e.active) simulation.alphaTarget(0); d.fx=null; d.fy=null; }

    // Populate filters
    fetch("/api/filters").then(r=>r.json()).then(filters=>{
      const countrySel=document.getElementById("country");
      const subfieldSel=document.getElementById("subfield");
      filters.countries.forEach(c=>countrySel.innerHTML+=`<option value="${c}">${c}</option>`);
      filters.subfields.forEach(s=>subfieldSel.innerHTML+=`<option value="${s}">${s}</option>`);
    });

    // First load
    drawGraph("/api/graph");

    // Search button
    document.getElementById("searchBtn").addEventListener("click",()=>{
      const author=document.getElementById("author").value;
      const country=document.getElementById("country").value;
      const subfield=document.getElementById("subfield").value;
      const year=document.getElementById("year").value;
      let url=`/api/graph?author=${author}&country=${country}&subfield=${subfield}&year=${year}`;
      drawGraph(url);
    });
  </script>
</body>
</html>

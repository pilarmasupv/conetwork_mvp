<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expert Connection Graph</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin:0; font-family:'Inter',sans-serif; background:#f7f5fb; }
    header { background:linear-gradient(90deg,#6a11cb 0%,#8e2de2 100%); color:white; padding:1rem 2rem; font-size:1.4rem; font-weight:600; }
    main { display:flex; height:calc(100vh - 70px); }
    aside { width:260px; background:white; padding:1rem; border-right:1px solid #ddd; overflow-y:auto; }
    aside h3 { margin-top:0; color:#6a11cb; }
    select,input,button { width:100%; margin:0.5rem 0; padding:0.5rem; border-radius:6px; border:1px solid #ccc; }
    button { background:#8e2de2; color:white; font-weight:600; cursor:pointer; border:none; }
    button:hover { background:#6a11cb; }
    .graph-container { flex:1; display:flex; justify-content:center; align-items:center; background:#fafafa; }
    svg { width:100%; height:100%; }
    .node { stroke:white; stroke-width:1.2px; cursor:pointer; }
    .link { stroke:#bbb; stroke-opacity:0.6; cursor:pointer; }
    /* Modal */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); }
    .modal-content { background:white; margin:10% auto; padding:20px; border-radius:8px; width:420px; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
    .close { float:right; font-size:20px; font-weight:bold; cursor:pointer; }
    .close:hover { color:#8e2de2; }
    .author-link { color:#6a11cb; cursor:pointer; }
    .author-link:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <header>Expert Connection Graph</header>
  <main>
    <aside>
      <h3>Filters</h3>
      <label>Country</label>
      <select id="country"><option value="all">All</option></select>

      <label>Subfield</label>
      <select id="subfield"><option value="all">All</option></select>

      <label>Year (min)</label>
      <input type="number" id="year" value="2010">

      <label>Author</label>
      <input type="text" id="author" placeholder="Search author...">

      <label><input type="checkbox" id="colorByGender"> Color by gender</label>

      <button id="searchBtn">Search</button>
    </aside>
    <div class="graph-container">
      <svg><g></g></svg>
    </div>
  </main>

  <!-- Modal -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>

  <script>
    const svg = d3.select("svg").select("g");
    let simulation, link, node;
    const modal = document.getElementById("infoModal");
    const modalBody = document.getElementById("modal-body");
    document.querySelector(".close").onclick = () => modal.style.display = "none";

    const zoom = d3.zoom().scaleExtent([0.1, 3]).on("zoom", (event) => {
      svg.attr("transform", event.transform);
    });
    d3.select("svg").call(zoom);

    function nodeColor(d) {
      if (document.getElementById("colorByGender").checked) {
        return d.gender === "Female" ? "#ff69b4" : "#1f77b4";
      }
      return "#8e2de2";
    }

    function drawGraph(apiUrl) {
      fetch(apiUrl).then(r => r.json()).then(data => {
        // Join edges
        link = svg.selectAll(".link")
          .data(data.edges, d => d.source.id + "-" + d.target.id)
          .join(
            enter => enter.append("line").attr("class","link")
              .on("click",(e,d)=>showEdgeInfo(d)),
            update => update,
            exit => exit.remove()
          );

        // Join nodes
        node = svg.selectAll(".node")
          .data(data.nodes, d => d.id)
          .join(
            enter => enter.append("circle")
              .attr("class","node")
              .attr("r",6)
              .attr("fill", nodeColor)
              .on("click",(e,d)=>showNodeInfo(d))
              .append("title").text(d => `${d.id}\n${d.subfield}`),
            update => update.attr("fill", nodeColor),
            exit => exit.remove()
          );

        simulation = d3.forceSimulation(data.nodes)
          .force("link", d3.forceLink(data.edges).id(d => d.id).distance(80))
          .force("charge", d3.forceManyBody().strength(-70))
          .force("center", d3.forceCenter(window.innerWidth/2.5, window.innerHeight/2));

        simulation.on("tick", () => {
          svg.selectAll(".link")
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
          svg.selectAll(".node")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
        });
      });
    }

    function showNodeInfo(d){
      modalBody.innerHTML = `
        <h3>${d.id}</h3>
        <p><b>Gender:</b> ${d.gender}</p>
        <p><b>Country:</b> ${d.country}</p>
        <p><b>Affiliation:</b> ${d.affiliation}</p>
        <p><b>Subfield:</b> ${d.subfield}</p>
        <p><b>Citations:</b> ${d.citations}</p>
        <p><b>Papers:</b><br> ${d.papers ? d.papers.join("<br>") : "N/A"}</p>
      `;
      modal.style.display="block";
    }

    function showEdgeInfo(d){
      modalBody.innerHTML = `
        <h3>${d.paper_title}</h3>
        <p><b>Year:</b> ${d.year}</p>
        <p><b>Venue:</b> ${d.venue}</p>
        <p><b>Authors:</b><br>
           ${[d.source.id, d.target.id].map(a => `<span class="author-link">${a}</span>`).join("<br>")}
        </p>
      `;
      modal.style.display="block";
      document.querySelectorAll(".author-link").forEach(el=>{
        el.onclick=()=>{
          const authorNode = simulation.nodes().find(n=>n.id===el.textContent);
          if (authorNode) showNodeInfo(authorNode);
        }
      });
    }

    // Populate filters
    fetch("/api/filters").then(r=>r.json()).then(filters=>{
      const countrySel=document.getElementById("country");
      const subfieldSel=document.getElementById("subfield");
      filters.countries.forEach(c=>countrySel.innerHTML+=`<option value="${c}">${c}</option>`);
      filters.subfields.forEach(s=>subfieldSel.innerHTML+=`<option value="${s}">${s}</option>`);
      document.getElementById("year").min = filters.years.min || 2000;
      document.getElementById("year").max = filters.years.max || 2025;
    });

    // First load
    drawGraph("/api/graph");

    // Search button
    document.getElementById("searchBtn").addEventListener("click",()=>{
      const author=document.getElementById("author").value;
      const country=document.getElementById("country").value;
      const subfield=document.getElementById("subfield").value;
      const year=document.getElementById("year").value;
      let url=`/api/graph?author=${author}&country=${country}&subfield=${subfield}&year=${year}`;
      drawGraph(url);
    });

    // Recolor on gender toggle
    document.getElementById("colorByGender").addEventListener("change",()=>{
      svg.selectAll(".node").attr("fill", nodeColor);
    });
  </script>
</body>
</html>
